<view class="container">
  <!-- Hidden Canvas for Image Processing -->
  <canvas type="2d" id="processCanvas" style="position:fixed; left:100%; width: 1024px; height: 1024px;"></canvas>
  <!-- Hidden Canvas for Splitting Grid -->
  <canvas type="2d" id="splitCanvas" style="position:fixed; left:100%; width: 512px; height: 512px;"></canvas>

  <!-- 🎨 Header with catchy slogan -->
  <view class="header">
    <text class="title">表情包制造机 🤪</text>
    <text class="subtitle">一秒变身沙雕艺术家</text>
  </view>

  <!-- Hero Stage -->
  <view class="card hero-stage-card">
    <view class="image-wrapper {{!originalImage ? 'clickable' : ''}}" bindtap="onHeroTap">
      
      <!-- Display Image -->
      <image 
        class="hero-image" 
        src="{{displayImage}}" 
        mode="aspectFit" 
        wx:if="{{displayImage}}">
      </image>
      
      <!-- Empty State -->
      <view class="placeholder" wx:else>
        <text class="placeholder-icon">📸</text>
        <text class="placeholder-text">戳我上传你的主子</text>
        <text class="placeholder-hint">支持喵星人/汪星人/人类</text>
      </view>
      
      <!-- Loading Overlay -->
      <view class="loading-overlay" wx:if="{{isGenerating}}">
        <view class="loading-content">
          <text class="loading-spinner">✨</text>
          <text class="loading-text">{{loadingText}}</text>
        </view>
      </view>

      <!-- Floating Swap Button -->
      <view class="swap-btn" catchtap="onSwapTap" wx:if="{{originalImage && !isGenerating}}">
        <text>🔄</text>
      </view>
    </view>
  </view>

  <!-- Control Panel -->
  <view class="card control-card">
    
    <!-- Style Selector -->
    <view class="style-selector {{!processedImage ? 'disabled' : ''}}">
      <text class="section-title">🎨 选择滤镜风格</text>
      <view class="style-tag-group">
        <view 
          class="style-tag {{currentStyle === item.value ? 'selected' : ''}}" 
          wx:for="{{styles}}" 
          wx:key="value"
          data-style="{{item.value}}"
          bindtap="onStyleTap">
          <text class="style-name">{{item.name}}</text>
          <text class="cache-dot" wx:if="{{styleCache[item.value]}}">✓</text>
        </view>
      </view>
    </view>


  </view>

  <!-- Footer hint -->
  <view class="footer">
    <text class="footer-text">✨ 每种风格独立生成，可以都试试哦~</text>
  </view>

  <!-- Fixed Bottom Bar -->
  <view class="bottom-bar">
    <!-- State A: Start Button -->
    <button 
      wx:if="{{!hasGenerated}}"
      class="btn generate-btn full-width" 
      bindtap="generateMeme" 
      disabled="{{!processedImage || isGenerating}}">
      <text>{{isGenerating ? '处理中...' : '🚀 开始整活'}}</text>
    </button>

    <!-- State B: Result Actions -->
    <view class="btn-group" wx:else>
      <button class="btn restart-btn" bindtap="onRestartTap">
        <text>🔄 重来</text>
      </button>
      <button class="btn save-btn" bindtap="saveImage">
        <text>💾 挑选保存</text>
      </button>
    </view>
  </view>

  <!-- Crop Popup using page-container -->
  <page-container 
    show="{{showCropPopup}}" 
    round="{{true}}"
    overlay="{{true}}"
    position="bottom"
    close-on-slide-down="{{true}}"
    bind:beforeleave="onCloseCropPopup"
  >
    <view class="crop-popup">
      <!-- Popup Header -->
      <view class="crop-popup-header">
        <text class="crop-popup-title">📦 挑选你的表情包</text>
        <text class="crop-popup-subtitle">点击选择要保存的图片</text>
      </view>

      <!-- Loading State -->
      <view class="crop-loading" wx:if="{{isCropping}}">
        <text class="crop-loading-icon">✂️</text>
        <text class="crop-loading-text">正在切图中...</text>
      </view>

      <!-- Grid of Cropped Images -->
      <view class="crop-grid" wx:else>
        <view 
          class="crop-item {{selectedMap[index] ? 'selected' : ''}}" 
          wx:for="{{croppedImages}}" 
          wx:key="index"
          data-index="{{index}}"
          bindtap="onToggleImageSelection"
        >
          <image class="crop-image" src="{{item}}" mode="aspectFill"></image>
          <view class="crop-check" wx:if="{{selectedMap[index]}}">
            <text>✓</text>
          </view>
          <view class="crop-index">{{index + 1}}</view>
        </view>
      </view>

      <!-- Popup Footer -->
      <view class="crop-popup-footer" wx:if="{{!isCropping}}">
        <view class="crop-selection-info">
          <text class="selection-count">已选 {{selectedCount}} 张</text>
          <text class="select-all-btn" bindtap="onSelectAll">全选</text>
        </view>
        <view class="crop-btn-group">
          <button class="btn crop-full-btn" bindtap="onSaveFullImage">
            <text>🖼️ 保存大图</text>
          </button>
          <button class="btn save-btn crop-save-btn" bindtap="onSaveSelectedImages" disabled="{{selectedCount === 0}}">
            <text>💾 保存选中</text>
          </button>
        </view>
      </view>
    </view>
  </page-container>

</view>
